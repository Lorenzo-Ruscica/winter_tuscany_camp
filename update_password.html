<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Password | Winter Tuscany Camp</title>
    
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/auth_page.css">
    <link rel="stylesheet" href="css/ui_bottons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #000; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; }
        .auth-container { background: #1e1e1e; padding: 40px; border-radius: 10px; border: 1px solid var(--color-hot-pink); max-width: 400px; width: 100%; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="auth-container">
        <h2 style="color: var(--color-hot-pink); margin-bottom: 20px;">New Password</h2>
        <p style="color: #ccc; margin-bottom: 20px;">Enter your new password below.</p>
        
        <form id="update-password-form">
            <input type="password" id="new-password" placeholder="New Password" required minlength="6">
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">UPDATE PASSWORD</button>
        </form>
        
        <p id="message" style="margin-top: 15px; font-size: 0.9rem;"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="javascript/config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 1. Controlla se siamo in una sessione di recupero
            // Quando clicchi il link della mail, l'URL contiene un hash con access_token
            // Supabase lo rileva automaticamente e imposta la sessione.
            
            const form = document.getElementById('update-password-form');
            const msg = document.getElementById('message');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const btn = form.querySelector('button');

                btn.disabled = true;
                btn.innerText = "Updating...";
                msg.innerText = "";

                try {
                    // QUESTA Ãˆ LA FUNZIONE CHIAVE: updateUser
                    const { data, error } = await window.supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (error) throw error;

                    // Successo
                    msg.style.color = "#2ecc71";
                    msg.innerText = "Password updated successfully! Redirecting...";
                    
                    // Dopo 2 secondi manda al login
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);

                } catch (err) {
                    console.error(err);
                    msg.style.color = "red";
                    msg.innerText = "Error: " + err.message;
                    btn.disabled = false;
                    btn.innerText = "UPDATE PASSWORD";
                }
            });
            
            // Verifica di sicurezza: Se l'utente non ha una sessione (es. link scaduto), lo cacciamo via
            const { data: { session } } = await window.supabase.auth.getSession();
            if (!session) {
                // Aspetta un attimo che Supabase processi l'hash dell'URL
                setTimeout(async () => {
                    const { data: { session: retrySession } } = await window.supabase.auth.getSession();
                    if (!retrySession) {
                        alert("Invalid or expired link. Please request a new reset link.");
                        window.location.href = 'login.html'; // O forgot-password.html
                    }
                }, 1000);
            }
        });
    </script>

</body>
</html>